version: '3.8'

services:
  # 1. MySQL 数据库服务
  mysql:
    image: mysql:8.0  # 使用 MySQL 8.0 镜像
    container_name: edu-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root123  #  root 密码（可修改）
      MYSQL_DATABASE: edu_ai_vote   # 自动创建的数据库名（和项目对应）
      MYSQL_CHARSET: utf8mb4
      MYSQL_COLLATION: utf8mb4_general_ci
    ports:
      - "3306:3306"  # 本地端口:容器端口（本地可通过 3306 连接）
    volumes:
      - mysql-data:/var/lib/mysql  # 数据持久化（重启不丢失数据）
      - ./mysql/init.sql:/docker-entrypoint-initdb.d/init.sql  # 初始化脚本
    networks:
      - edu-network  # 所有服务在同一网络，可通过服务名访问

  # 2. Java 后端服务（依赖 MySQL）
  backend:
    build: ./backend  # 基于 backend 目录的 Dockerfile 构建
    container_name: edu-backend
    restart: always
    depends_on:
      - mysql  # 先启动 MySQL 再启动后端
    environment:
      # 后端连接 MySQL 的配置（和上面 MySQL 环境变量对应）
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/edu_ai_vote?useSSL=false&serverTimezone=Asia/Shanghai
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root123
    ports:
      - "8001:8001"  # 后端接口端口（Cool Admin 后端默认 8001）
    networks:
      - edu-network

  # 3. Vue3 前端服务（依赖后端）
  frontend:
    build: ./frontend  # 基于 frontend 目录的 Dockerfile 构建
    container_name: edu-frontend
    restart: always
    depends_on:
      - backend  # 先启动后端再启动前端
    ports:
      - "9000:9000"  # 前端访问端口（Cool Admin 前端默认 9000）
    networks:
      - edu-network

# 数据卷：持久化 MySQL 数据
volumes:
  mysql-data:

# 自定义网络：让服务之间可通过服务名通信（如 backend 访问 mysql:3306）
networks:
  edu-network:
    driver: bridge
